<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,0,0" />
    <!-- <link rel="stylesheet" type="text/css" href="style.css"> -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <title>reddit - single page client</title>
</head>

<body>
    <div class="container">
        <div class="w3-cell-row">

            <div class="w3-container w3-red w3-cell">
              <p>Hello W3.CSS Layout.</p>
            </div>
          
            <div class="w3-container w3-green w3-cell">
              <p>Hello W3.CSS Layout.</p>
            </div>
          
        </div>
    
        <ul id="container" class="posts">
            <h>
                <label for="subRedditInput">r/</label>
                <input type="text" id="subRedditInput" list="subList" placeholder="hot" onchange="changeSub(value)">
                <datalist id="subList"></datalist>
            </h>
            <li class="error" id="errMsg"></li>
        </ul>

        <p>
            <a id="moreButton">
                <b>more </b>
                <span class="material-symbols-rounded" style="float:right;">
                    cached
                </span>
            </a>
        </p>
        <p></p>

        <div class="comments" id="commentsContainer">
            <article id="pageComment"></article>
        </div>
    </div>

    <script>
        var lastPost = ''
        var subReddit = ''
        var loading = false
        var subbed_subreddits = JSON.parse(localStorage.getItem('sub-reds')) || ['hot'];

        var getDate = function(date) {
            let d = new Date(date * 1000)
            return `${d.getHours()}:${d.getMinutes()} ${d.getDay()}-${d.getMonth()}-${d.getFullYear()}`
        }
        function checkImg(url) {
            return (/\.(jpg|jpeg|png|webp|avif|gif|svg)$/.test(url)) ? url : `https://via.placeholder.com/140x100`
        }
        function changeSub(sub) {
            const posts = document.querySelectorAll('.post')
            posts.forEach(p => p.remove())
            this.lastPost = ''
            this.subReddit = sub
            console.log(sub)
            populatePage(sub)
        }
        function errorHandler(err) {
            document.getElementById('errMsg').innerHTML = err
            document.getElementById('errMsg').style = 'display:contents;'
            console.error(err)
            return err
        }
        function getComments(data) {
            console.log(data)
            this.loading = true
            //let cont = document.getElementById('commentsContainer')
            commentsBlock = document.getElementById('pageComment')
            if(data.is_video == true) {
                commentsBlock.innerHTML = `
                <video width="${data.media.reddit_video.width}" height="${data.media.reddit_video.height}" controls autoplay muted>
                    <source src="${data.media.reddit_video.dash_url}" type="video/mp4">
                    <source src="${data.media.reddit_video.fallback_url}" type="video/ogg">
                Your browser does not support the video tag.
                </video>
                `
            } else {
                commentsBlock.innerHTML = `<img src=${checkImg(data.url)}>`
            }
            commentsBlock.innerHTML += `<div>${data.title}</div>`
            commentsBlock.style.top = Math.round(window.scrollY)+'px'
            let url = `https://www.reddit.com${data.permalink}.json`
            let fetchPromise = fetch(url)
            fetchPromise.then((response) => {
              let jsonPromise = response.json()
              jsonPromise.then((data) => {
                
                let ul = document.createElement('ul')
                commentsBlock.appendChild(ul)
                data[1].data.children.forEach(async (com) => {
                    let li = document.createElement('li')
                    li.textContent = com.data.body
                    ul.appendChild(li)
                })

              })
              .then(this.loading = false)
            })
        }
        function populatePage(postSub) {
            this.loading = true
            let fetchPromise = fetch(`https://www.reddit.com/r/${this.subReddit}/.json?after=${this.lastPost}`)
            fetchPromise.then((response) => {
              let jsonPromise = response.json()
              jsonPromise.then((data) => {
                //this.subReddit = postSub
                let ul = document.getElementById('container')
                document.getElementById('subRedditInput').setAttribute('value', subReddit)

                data.data.children.forEach(async p => {
                    let li = document.createElement('li')
                    li.id = p.data.id
                    li.classList.add('post')
                    li.innerHTML = `
                    <a href="${p.data.url}" target="_blank" style="background-image: url(${checkImg(p.data.thumbnail)})"></a>
                    <div>${p.data.title}</div>
                    <u><b class="num-com">&#8865; ${p.data.num_comments} 
                        &#8743; ${p.data.ups} </b>
                        <i class="user">[${p.data.author}]</i> | 
                        <i class="time">${(getDate(p.data.created))}</i> | 
                        <b class="sub-red">r/${p.data.subreddit}</b></u>`
                        li.addEventListener('click', (event) => {
                            event.preventDefault()
                            let others = document.querySelectorAll('.post')
                            others.forEach((el) => el.style = 'background-color: #17140F;')
                            
                            li.style = 'background-color: #2C2B20;'
                            getComments(p.data)
                        })
                    ul.appendChild(li)
                    this.lastPost = p.data.name
                })
                
                return data
              })
              .then((data) => localStorage.setItem(postSub, JSON.stringify(data)))
              .then(document.getElementById('moreButton').style = 'display: block;')
              .then(this.loading = false)
              .catch(err => errorHandler(err))
            })
        }
        (function() {
            datalist = document.getElementById('subList')
            localStorage.setItem('sub-reds', JSON.stringify(subbed_subreddits))

            subbed_subreddits.forEach(sub => {
                let option = document.createElement('option')
                option.value = sub
                datalist.appendChild(option)
            })

            moreButton.onclick = (e) => {
                e.preventDefault()
                if (this.loading == false) populatePage(subReddit)
            }

            this.subReddit = 'funny'
            populatePage(subReddit)

        })()
        
    </script>
</body>
</html>